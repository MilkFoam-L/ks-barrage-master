# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå¿«æ‰‹ç›´æ’­å¼¹å¹•é‡‡é›†ç³»ç»Ÿï¼Œé€šè¿‡WebSocketè¿æ¥å¿«æ‰‹ç›´æ’­é—´è·å–å®æ—¶å¼¹å¹•æ•°æ®ã€‚ç³»ç»Ÿä½¿ç”¨Protocol Buffersè¿›è¡Œæ•°æ®åºåˆ—åŒ–ï¼Œæ”¯æŒå•ä¸ªç›´æ’­é—´å’Œæ‰¹é‡å¤„ç†å¤šä¸ªç›´æ’­é—´ã€‚

## å¸¸ç”¨å‘½ä»¤

### å®‰è£…ä¾èµ–
```bash
pip3 install -r requirements.txt
```

### è¿è¡Œå¼¹å¹•é‡‡é›†

#### ğŸ†• æ–¹æ³•ä¸€ï¼šè‡ªåŠ¨åŒ–è§£æï¼ˆæ¨èï¼‰
ä½¿ç”¨æ‰‹åŠ¨è·å–çš„hexæ•°æ®è‡ªåŠ¨è§£æå‚æ•°ï¼š

```bash
# äº¤äº’å¼è¾“å…¥æ¨¡å¼ï¼ˆæ¨èæ–°æ‰‹ä½¿ç”¨ï¼‰
python -m barrage.manual_hex_barrage --interactive

# å‘½ä»¤è¡Œç›´æ¥è¾“å…¥hexæ•°æ®
python -m barrage.manual_hex_barrage --hex "ä½ çš„hexæ•°æ®" --websocket-url "WebSocketåœ°å€"

# ä»…è§£æå‚æ•°ï¼Œä¸å¯åŠ¨é‡‡é›†
python -m barrage.manual_hex_barrage --hex "ä½ çš„hexæ•°æ®" --parse-only
```

**è·å–hexæ•°æ®çš„æ­¥éª¤ï¼š**
1. è®¿é—®ç›´æ’­é—´ï¼šhttps://live.kuaishou.com/u/Kslala666
2. æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ°Networké¢æ¿
3. è¿‡æ»¤"websocket"æˆ–"WS"è¿æ¥
4. æ‰¾åˆ°WebSocketè¿æ¥ï¼Œåˆ‡æ¢åˆ°Messagesæ ‡ç­¾
5. å¤åˆ¶ç¬¬ä¸€ä¸ªå‘é€æ¶ˆæ¯çš„hexæ•°æ®

#### æ–¹æ³•äºŒï¼šä¼ ç»Ÿæ‰‹åŠ¨æ¨¡å¼
```bash
python -m barrage.ks_barrage --live-id "ç›´æ’­é—´ID"
```

#### æ–¹æ³•ä¸‰ï¼šURLæ¨¡å¼ï¼ˆå®éªŒæ€§ï¼Œå¯èƒ½è¢«åçˆ¬è™«é˜»æ­¢ï¼‰
```bash
python -m barrage.ks_barrage --url "https://live.kuaishou.com/u/ç”¨æˆ·å" --show-browser
```

### ğŸ”§ è·å–hexæ•°æ®è¯¦ç»†æŒ‡å¯¼

```bash
# æ˜¾ç¤ºè¯¦ç»†çš„è·å–æŒ‡å¯¼
python -m barrage.manual_hex_barrage --help-guide
```

### ç¤ºä¾‹hexæ•°æ®æ ¼å¼
```
08c8011a88020ad8015a322b77743234764b484e4138685774544a614b48474478747a67532f6d4f337634464d643437543876363632417a706b5476315437385a53556f4c617a594248636d43386e35467837734d796f53794358436458796863574143384a4c366a6537456a39523945575a46506c6a552b644144574173614378764f6b583751374a7268504943442f65746c46466d644e4e5731537a4c32776d712f54554273336f4d5759444645536b586e665676774b4a4d3764313249713971635336383370686d79446d512f2f346f37622b3932795859556f37413d3d120b4539636452656d477a4f493a1e61346277484567585342673066764e735f31373538313936363034373334
```

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆæ¨èï¼‰

### ğŸ¯ ä¸€é”®å¯åŠ¨ - æ™ºèƒ½æ¨¡å¼
```bash
python -m barrage.ultimate "https://live.kuaishou.com/u/Kslala666"
```
**æ™ºèƒ½æ¨¡å¼ä¼šè‡ªåŠ¨é€‰æ‹©æœ€ä½³æ–¹æ³•ï¼Œæ— éœ€ä»»ä½•é…ç½®ï¼**

### ğŸ“‹ æ‰€æœ‰å¯ç”¨æ¨¡å¼

#### 1. ğŸ§  æ™ºèƒ½æ¨¡å¼ï¼ˆæ¨èï¼‰
è‡ªåŠ¨å°è¯•å„ç§æ–¹æ³•ï¼Œç›´åˆ°æˆåŠŸï¼š
```bash
python -m barrage.ultimate "ç›´æ’­é—´URL"
```

#### 2. ğŸ¤– å®Œå…¨è‡ªåŠ¨åŒ–æ¨¡å¼
å°è¯•å®Œå…¨è‡ªåŠ¨è·å–å‚æ•°ï¼š
```bash
python -m barrage.ultimate "ç›´æ’­é—´URL" --auto --show-browser
```

#### 3. ğŸ”§ åŠè‡ªåŠ¨åŒ–æ¨¡å¼
å¼•å¯¼ç”¨æˆ·æ‰‹åŠ¨è·å–hexæ•°æ®ï¼š
```bash
python -m barrage.ultimate "ç›´æ’­é—´URL" --semi-auto
```

#### 4. âœ‹ æ‰‹åŠ¨æ¨¡å¼
ç”¨æˆ·æä¾›æ‰€æœ‰å‚æ•°ï¼š
```bash
python -m barrage.ultimate --manual
```

#### 5. ğŸ® äº¤äº’å¼æ¨¡å¼
äº¤äº’å¼é€‰æ‹©æ¨¡å¼ï¼š
```bash
python -m barrage.ultimate --interactive
```

### ğŸ”§ è·å–hexæ•°æ®è¯¦ç»†æŒ‡å¯¼

```bash
# æ˜¾ç¤ºè¯¦ç»†çš„è·å–æŒ‡å¯¼
python -m barrage.manual_hex_barrage --help-guide
```

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼
```bash
# ä¸€é”®å¯åŠ¨ï¼Œç¨‹åºä¼šè‡ªåŠ¨å¤„ç†æ‰€æœ‰äº‹æƒ…
python -m barrage.ultimate "https://live.kuaishou.com/u/Kslala666"
```

### å¦‚æœè‡ªåŠ¨åŒ–å¤±è´¥ï¼Œä½¿ç”¨åŠè‡ªåŠ¨æ¨¡å¼
```bash
# ç¨‹åºä¼šå¼•å¯¼æ‚¨æ‰‹åŠ¨è·å–å¿…è¦çš„æ•°æ®
python -m barrage.ultimate "https://live.kuaishou.com/u/Kslala666" --semi-auto
```

### ä¼ ç»Ÿæ–¹å¼ï¼ˆå…¼å®¹æ€§ï¼‰
```bash
# ä¼ ç»Ÿæ‰‹åŠ¨hexè¾“å…¥
python -m barrage.manual_hex_barrage --interactive

# ä¼ ç»Ÿlive_idæ¨¡å¼
python -m barrage.ks_barrage --live-id "ç›´æ’­é—´ID"
```

## ğŸ¬ å·¥ä½œæµç¨‹

1. **æ™ºèƒ½æ¨¡å¼é¦–å…ˆå°è¯•å®Œå…¨è‡ªåŠ¨åŒ–**
   - è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨è®¿é—®ç›´æ’­é—´
   - è‡ªåŠ¨æ•è·WebSocketè¿æ¥å’Œå‚æ•°
   - å¦‚æœæˆåŠŸï¼Œç›´æ¥å¼€å§‹é‡‡é›†å¼¹å¹•

2. **å¦‚æœè‡ªåŠ¨åŒ–å¤±è´¥ï¼Œåˆ‡æ¢åˆ°åŠè‡ªåŠ¨åŒ–**
   - æ˜¾ç¤ºè¯¦ç»†çš„æ‰‹åŠ¨è·å–æŒ‡å¯¼
   - ç”¨æˆ·æŒ‰æŒ‡å¯¼è·å–hexæ•°æ®
   - ç¨‹åºè‡ªåŠ¨è§£æå¹¶å¼€å§‹é‡‡é›†

3. **æœ€åå¤‡é€‰ï¼šå®Œå…¨æ‰‹åŠ¨æ¨¡å¼**
   - ç”¨æˆ·æ‰‹åŠ¨æä¾›æ‰€æœ‰å‚æ•°
   - ç¨‹åºç›´æ¥å¼€å§‹é‡‡é›†

## ğŸ’¡ å¸¸è§é—®é¢˜

**Q: é‡åˆ°éªŒè¯ç æ€ä¹ˆåŠï¼Ÿ**
A: å¦‚æœè‡ªåŠ¨åŒ–é‡åˆ°éªŒè¯ç ï¼Œç¨‹åºä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°åŠè‡ªåŠ¨åŒ–æ¨¡å¼

**Q: å“ªç§æ¨¡å¼æœ€æ¨èï¼Ÿ**
A: æ™ºèƒ½æ¨¡å¼ï¼Œå®ƒä¼šè‡ªåŠ¨é€‰æ‹©æœ€é€‚åˆçš„æ–¹æ³•

**Q: å¦‚ä½•è°ƒè¯•é—®é¢˜ï¼Ÿ**
A: ä½¿ç”¨ `--show-browser` å‚æ•°æŸ¥çœ‹æµè§ˆå™¨çŠ¶æ€

**Q: ç¨‹åºä¸€ç›´å¡ä½ä¸åŠ¨ï¼Ÿ**
A: æŒ‰Ctrl+Cä¸­æ–­ï¼Œç„¶åå°è¯•åŠè‡ªåŠ¨åŒ–æ¨¡å¼

### æ‰¹é‡å¤„ç†å¤šä¸ªç›´æ’­é—´
éœ€è¦å…ˆé…ç½®RabbitMQï¼Œç„¶åï¼š
```bash
python -m barrage.ks_barrage_batch
```

### ç¼–è¯‘Protocol Buffers
```bash
sh proto/compile.sh
```
æˆ–æ‰‹åŠ¨ç¼–è¯‘ï¼š
```bash
python -m grpc_tools.protoc -I . --python_out=. proto/ks_barrage.proto
```

### ä½¿ç”¨protobuf-inspectoråˆ†ææ•°æ®åŒ…
```bash
protobuf_inspector < my-protobuf
```

## æ ¸å¿ƒæ¶æ„

### æ•°æ®æµæ¶æ„
1. **WebSocketè¿æ¥**: é€šè¿‡websocket-client-py3è¿æ¥å¿«æ‰‹ç›´æ’­é—´WebSocketæœåŠ¡å™¨
2. **Protocol Buffers**: ä½¿ç”¨protobufè¿›è¡Œæ•°æ®åºåˆ—åŒ–/ååºåˆ—åŒ–
3. **æ¶ˆæ¯é˜Ÿåˆ—**: é€šè¿‡RabbitMQå®ç°å¤šç›´æ’­é—´ä»»åŠ¡åˆ†å‘
4. **å¤šçº¿ç¨‹å¤„ç†**: æ¯ä¸ªç›´æ’­é—´åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­å¤„ç†å¼¹å¹•æ•°æ®

### å…³é”®ç»„ä»¶

#### å¼¹å¹•å¤„ç†æ ¸å¿ƒ (`barrage/ks_barrage.py`)
- `KuaishouBarrage`ç±»ï¼šä¸»è¦çš„å¼¹å¹•é‡‡é›†å™¨
- å¤„ç†WebSocketè¿æ¥ç”Ÿå‘½å‘¨æœŸï¼ˆè¿æ¥ã€æ¶ˆæ¯æ¥æ”¶ã€é”™è¯¯å¤„ç†ã€å…³é—­ï¼‰
- å®ç°å¿ƒè·³æœºåˆ¶ç»´æŒè¿æ¥ï¼ˆæ¯20ç§’å‘é€ä¸€æ¬¡ï¼‰
- æ ¹æ®å¼¹å¹•ç±»å‹ä½¿ç”¨ä¸åŒçš„protobufç»“æ„è§£ææ•°æ®

#### Protocol Bufferså®šä¹‰ (`proto/ks_barrage.proto`)
- `Request`: WebSocketè¿æ¥è¯·æ±‚æ•°æ®ç»“æ„
- `Barrage`: å¼¹å¹•æ•°æ®ä¸»ç»“æ„
- `BarrageContent`: å¼¹å¹•å†…å®¹ï¼ˆè§‚ä¼—æ•°ã€ç‚¹èµæ•°ã€æ¶ˆæ¯åˆ—è¡¨ï¼‰
- `BarrageMessage`: å•æ¡å¼¹å¹•æ¶ˆæ¯
- `HeartbeatClient`: å®¢æˆ·ç«¯å¿ƒè·³åŒ…
- `BarrageType`: å¼¹å¹•ç±»å‹æšä¸¾ï¼ˆå¿ƒè·³ã€è¿æ¥æˆåŠŸã€å¼¹å¹•ã€è§‚ä¼—æ’è¡Œç­‰ï¼‰

#### æ‰¹é‡å¤„ç†ç³»ç»Ÿ
- `barrage/ks_barrage_batch.py`: ä»RabbitMQé˜Ÿåˆ—è·å–ä»»åŠ¡å¹¶åˆ›å»ºå¤„ç†çº¿ç¨‹
- `barrage/process.py`: æä¾›åå°çº¿ç¨‹/è¿›ç¨‹æ‰§è¡Œå·¥å…·ç±»
- `config.py`: RabbitMQè¿æ¥é…ç½®

### è®¤è¯å’Œè¿æ¥
- éœ€è¦ç™»å½•è´¦å·è·å–tokenæ‰èƒ½é‡‡é›†å¼¹å¹•
- WebSocket URLæ ¼å¼ï¼š`wss://livejs-ws-group*.gifshow.com/websocket`
- è¿æ¥å‚æ•°åŒ…æ‹¬ï¼štokenã€live_idã€page_id
- page_idç”Ÿæˆç®—æ³•åŸºäºå›ºå®šå­—ç¬¦é›†å’Œæ—¶é—´æˆ³

### æ•°æ®è§£ææµç¨‹
1. æ¥æ”¶WebSocketäºŒè¿›åˆ¶æ¶ˆæ¯
2. ä½¿ç”¨`ResponseCommon`è§£ææ¶ˆæ¯å¤´ç¡®å®šå¼¹å¹•ç±»å‹
3. æ ¹æ®ç±»å‹é€‰æ‹©å¯¹åº”çš„protobufç»“æ„ä½“è§£æ
4. å°†protobufæ¶ˆæ¯è½¬æ¢ä¸ºJSONæ ¼å¼è¾“å‡º

## å¼€å‘æ³¨æ„äº‹é¡¹

- ä¿®æ”¹`barrage/ks_barrage.py`ä¸­çš„live_idæ¥é‡‡é›†ä¸åŒç›´æ’­é—´
- tokenå¯èƒ½æœ‰æ—¶æ•ˆæ€§ï¼Œéœ€è¦å®šæœŸæ›´æ–°
- ä¸åŒç›´æ’­é—´å¯èƒ½å¯¹åº”ä¸åŒçš„WebSocketæœåŠ¡å™¨ç»„
- ä½¿ç”¨`protobuf_inspector`å·¥å…·åˆ†ææœªçŸ¥æ•°æ®åŒ…ç»“æ„
- ç³»ç»Ÿéœ€è¦RabbitMQæ”¯æŒæ‰¹é‡å¤„ç†åŠŸèƒ½

## æ–‡ä»¶ç»“æ„è¦ç‚¹

- `proto/`: Protocol Bufferså®šä¹‰å’Œç¼–è¯‘è„šæœ¬
- `barrage/`: æ ¸å¿ƒå¼¹å¹•é‡‡é›†é€»è¾‘
- `celery_ks/`: Celeryä»»åŠ¡é˜Ÿåˆ—é…ç½®ï¼ˆå¯é€‰ï¼‰
- `config.py`: RabbitMQé…ç½®
- `parse_hex.py`: åå…­è¿›åˆ¶æ•°æ®è§£æå·¥å…·